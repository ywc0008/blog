# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Tech Stack

- **Framework**: Astro 5.x (Static Site Generator)
- **UI**: React 19.x (Islands Architecture - minimal interactive components only)
- **Styling**: TailwindCSS 4.x (manual integration via @tailwindcss/vite, NO @astrojs/tailwind)
- **Content**: MDX with Content Collections API
- **Image Processing**: Sharp 0.34.x (REQUIRED for Astro Image optimization)
- **Code Highlighting**: Shiki (build-time)
- **Comments**: Giscus (GitHub Discussions)
- **Analytics**: Google Analytics (Partytown) + Cloudflare Web Analytics (auto-injected via proxy mode)
- **TypeScript**: 5.x with strict mode

## Commands

```bash
# Development
pnpm dev                 # Start dev server at localhost:4321
pnpm build              # Production build to ./dist/
pnpm preview            # Preview production build
pnpm preview:cf         # Cloudflare Pages local preview

# Code Quality
pnpm lint               # Run ESLint with auto-fix
pnpm format             # Format with Prettier
pnpm check              # TypeScript type checking (astro check)
```

**Important**: To save tokens, do NOT automatically run build/check/lint/format commands. Instead, ask the user to run these commands manually and report back when complete.

## Architecture

### Astro Islands Pattern

- **Astro Components** (`.astro`): Static components with 0 bytes JS by default
- **React Components** (`.tsx`): Only for interactive features that need state/events
- Use `client:load` or `client:idle` directives sparingly

### Component Classification Rules

- **React (.tsx)**: Components with useState, useEffect, onClick handlers
- **Astro (.astro)**: Everything else (layouts, static UI, wrappers)
- Current React components: None (all features implemented with Astro + vanilla JS)

### Content Management

- **Blog Posts**: `src/content/blog/*.mdx` - MDX files with frontmatter
- **Content Schema**: Defined in `src/content/config.ts` using Zod
- **Categories**: Defined in `src/content/categories.json` (Development, Library, Projects, Performance, TypeScript)
- **Category System**: Single category per post (broad classification) + multiple tags (specific topics)
- **Images**: Store in `src/assets/posts/[post-name]/` for Astro Image optimization
- **Access**: Use `getCollection("blog")` from `astro:content`

#### Blog Post Frontmatter

```yaml
title: string
description: string
pubDate: Date (YYYY-MM-DDTHH:mm:ssZ format)
updatedDate?: Date (optional)
heroImage?: ImageMetadata (../../assets/posts/folder/image.jpg)
category: string (must match categories.json)
tags: string[]
draft: boolean
```

#### Creating New Blog Posts

1. Create MDX file in `src/content/blog/[post-name].mdx`
2. Add hero image (if any) to `src/assets/posts/[post-name]/`
3. Ensure `category` matches one from `src/content/categories.json`
4. Use lowercase for tags (consistency)
5. Set `draft: true` for unpublished posts
6. Use ISO 8601 format for dates: `2024-03-13T00:00:00Z`

### Styling Approach

- **NO embedded `<style>` tags or @apply directives**
- **Use inline TailwindCSS utility classes only**
- **Exception**: `src/styles/global.css` for MDX prose styles (`.prose h2`, `.prose p`, etc.)
- **NO dark mode**: All dark mode code has been removed
- **Design System**: Minimalist gray tones (gray-50 to gray-900) with blue accents only for categories (bg-blue-100, text-blue-800)
- **Interactive Components**: Use Intersection Observer API for scroll-based features (see TOC.astro)

### URL Structure

- Posts: `/posts/[slug]`
- Categories: `/categories/[category]` (lowercase)
- Tags: `/tags/[tag]` (lowercase)
- RSS: `/rss.xml`
- LLMs.txt: `/llms.txt` (AI í¬ë¡¤ëŸ¬ìš© ì‚¬ì´íŠ¸ ìš”ì•½)
- LLMs-full.txt: `/llms-full.txt` (AI í¬ë¡¤ëŸ¬ìš© ìƒì„¸ ì½˜í…ì¸  ê°€ì´ë“œ)
- Sitemap: Auto-generated by @astrojs/sitemap

**CRITICAL**: Always use `post.slug` for URLs, NOT `post.id`

- `post.id` includes file extension (e.g., "Luxon.mdx")
- `post.slug` is URL-safe without extension (e.g., "luxon")
- Bad: `params: { slug: post.id }` â†’ `/posts/Luxon.mdx/`
- Good: `params: { slug: post.slug }` â†’ `/posts/luxon/`

### Image Optimization

- **CRITICAL**: Sharp must be installed as a dependency (`pnpm add sharp`)
- **Astro Image Component**: Used in Card.astro and [slug].astro
- **Storage**: `src/assets/posts/[post-name]/` (NOT `public/`)
- **Type**: `heroImage: image().optional()` in Content Collections schema returns `ImageMetadata`
- **Auto-optimization**: JPG/PNG â†’ WebP, responsive srcset, lazy loading
- **BlogPost Type**: `heroImage?: ImageMetadata` in `src/types/index.ts`
- **Cloudflare Deployment**: Without Sharp, builds will fail with MissingSharp error

### Key Files

- `astro.config.mjs`: Site URL (https://ywc.life), integrations, Shiki config (github-dark theme)
- `src/content/config.ts`: Content Collections schema with `image()` helper
- `src/content/categories.json`: Available categories (Development, Library, Projects, Performance, TypeScript)
- `src/types/index.ts`: TypeScript types including BlogPost with ImageMetadata
- `src/layouts/BaseLayout.astro`: Base HTML structure, SEO component
- `src/components/astro/SEO.astro`: SEO/GEO meta tags (OG, Twitter Card, JSON-LD BlogPosting, BreadcrumbList, SearchAction)
- `src/components/astro/Card.astro`: Blog post card with hero image, category, tags links
- `src/components/astro/Header.astro`: Navigation with Development/Library categories + Search
- `src/components/astro/Search.astro`: Pagefind search modal with âŒ˜K shortcut (is:inline script)
- `src/components/astro/Footer.astro`: Footer with RSS and GitHub links
- `src/components/astro/TOC.astro`: Table of contents with Intersection Observer for current section highlighting
- `src/pages/posts/[slug].astro`: Post detail page with hero image display and TOC sidebar
- `src/pages/llms.txt.ts`: AI í¬ë¡¤ëŸ¬ìš© ì‚¬ì´íŠ¸ ìš”ì•½ ì—”ë“œí¬ì¸íŠ¸ (ë¹Œë“œ íƒ€ì„ ìƒì„±)
- `src/pages/llms-full.txt.ts`: AI í¬ë¡¤ëŸ¬ìš© ìƒì„¸ ì½˜í…ì¸  ê°€ì´ë“œ (ë¹Œë“œ íƒ€ì„ ìƒì„±)
- `src/pages/404.astro`: Custom 404 page with recent posts suggestions
- `.nvmrc`: Node 20 for Cloudflare Pages deployment
- `wrangler.jsonc`: Cloudflare Pages configuration

### SEO & GEO (Generative Engine Optimization)

- **JSON-LD Schemas**: WebSite (with SearchAction), BlogPosting (with mainEntityOfPage, publisher), BreadcrumbList
- **SEO.astro Props**: `title`, `description`, `image`, `type`, `breadcrumb`, `article` (with `section`, `wordCount`)
- **BaseLayout â†’ SEO ì „ë‹¬**: breadcrumb, article.section, article.wordCount í¬í•¨
- **robots.txt**: AI í¬ë¡¤ëŸ¬ 13ì¢… ëª…ì‹œì  í—ˆìš© (GPTBot, ClaudeBot, PerplexityBot ë“±)
- **llms.txt**: Astro ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¹Œë“œ íƒ€ì„ì— ìë™ ìƒì„±
- **Trailing Slash ì£¼ì˜**: `context.site`ëŠ” URL ê°ì²´ì´ë¯€ë¡œ ë¬¸ìì—´ ê²°í•© ì‹œ `.toString().replace(/\/$/, "")` í•„ìš”

### Search (Pagefind)

- **Implementation**: `src/components/astro/Search.astro` with `is:inline` script
- **Build**: `astro build && pagefind --site dist` (package.json build script)
- **Keyboard Shortcut**: âŒ˜K (Mac) / Ctrl+K (Windows) to open search modal
- **Indexing**: Pagefind creates static search index at build time in `/pagefind/`
- **Testing**: Search only works in `pnpm preview` (not `pnpm dev`) because index is generated at build time

## Development Constraints

- **No SSR**: Static generation only (`astro build`)
- **Build-time processing**: MDX, Shiki, Pagefind, image optimization all at build time
- **No state management libraries**: Use Astro's built-in features
- **No dark mode**: Removed for simplicity
- **is:inline scripts**: Must use pure JavaScript (no TypeScript syntax like `as` casts)

## Deployment

### Cloudflare Pages

Project is configured for Cloudflare Pages deployment:

- **Site URL**: https://ywc.life (set in `astro.config.mjs`)
- **Build Command**: `pnpm build`
- **Output Directory**: `dist`
- **Node.js Version**: 20 (set `NODE_VERSION=20` in environment variables)
- **CRITICAL**: Sharp must be in dependencies for image optimization to work

`wrangler.jsonc`:

```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "ywc-life-blog",
  "compatibility_date": "2026-01-18",
  "pages_build_output_dir": "./dist",
}
```

#### Cloudflare Dashboard Setup

1. **Create Pages Project**: Workers & Pages â†’ Create â†’ Pages â†’ Connect to Git
2. **Select Repository**: `ywc0008/blog`
3. **Build Settings**: Framework preset `Astro`, Build command `pnpm build`, Output directory `dist`
4. **Environment Variables**: Set `NODE_VERSION=20`
5. **Custom Domain**: Custom domains â†’ Set up a custom domain â†’ `ywc.life`

#### Cloudflare Web Analytics

Web Analytics is **automatically injected** when DNS proxy mode (orange cloud ğŸŸ ) is enabled.
No code changes needed - Cloudflare injects the analytics script automatically.

To view analytics: Cloudflare Dashboard â†’ Analytics & Logs â†’ Web Analytics

### Giscus Configuration

Giscus comments are already configured in `src/components/astro/Comments.astro`:

```typescript
const repo = "ywc0008/blog";
const repoId = "R_kgDOQ1_i3A";
const category = "General";
const categoryId = "DIC_kwDOQ1_i3M4C0zIb";
```

These values are public and safe to commit. Comments are displayed via GitHub Discussions integration.

## Security

### XSS Protection

- Astro and React provide automatic XSS protection by default
- MDX content is safely rendered through Astro's Content Collections API
- All user-facing content is validated through Zod schemas in `src/content/config.ts`
- No unsafe HTML rendering patterns are used in this codebase

### External Links

- External links must include `rel="noopener noreferrer"` to prevent tabnabbing attacks
- Example pattern in `Footer.astro`:
  ```typescript
  target={link.href.startsWith("http") ? "_blank" : undefined}
  rel={link.href.startsWith("http") ? "noopener noreferrer" : undefined}
  ```

### Third-Party Scripts

- Giscus script loaded from `https://giscus.app/client.js` with `crossOrigin="anonymous"`
- Google Analytics integrated via Google Tag Manager with Partytown
- Cloudflare Web Analytics auto-injected via proxy mode (no manual script needed)
- No Subresource Integrity (SRI) hashes used (not provided by Giscus)

### Content Security

- All blog content stored in Git repository (version controlled)
- Draft posts filtered at build time via `draft: boolean` frontmatter field
- No runtime content injection or dynamic user input processing
- Static site generation eliminates SQL/command injection vectors

## Known Issues & Important Notes

- **Sharp Dependency**: MUST be installed for Astro Image. Cloudflare Pages builds fail without it (MissingSharp error)
- **Pagefind Dev Mode**: Search doesn't work in `pnpm dev` - use `pnpm build && pnpm preview` to test
- **is:inline Scripts**: Cannot use TypeScript syntax (no `as HTMLElement`, no type annotations)
- **Astro context.site Trailing Slash**: `context.site`ëŠ” `URL` ê°ì²´ë¡œ `toString()` ì‹œ trailing slash í¬í•¨. ê²½ë¡œ ê²°í•© ì‹œ ì´ì¤‘ ìŠ¬ë˜ì‹œ(`//`) ë°œìƒ ì£¼ì˜ â†’ `.toString().replace(/\/$/, "")` ì‚¬ìš©
- **Git Commits**:
  - Write commit messages in Korean (project convention)
  - DO NOT add "Co-Authored-By" to commit messages
  - Follow conventional commits format: `feat:`, `fix:`, `docs:`, `design:`, etc.

<!-- MANUAL ADDITIONS START -->
<!-- MANUAL ADDITIONS END -->
