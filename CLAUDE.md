# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Tech Stack

- **Framework**: Astro 5.x (Static Site Generator)
- **UI**: React 19.x (Islands Architecture - minimal interactive components only)
- **Styling**: TailwindCSS 4.x (manual integration via @tailwindcss/vite, NO @astrojs/tailwind)
- **Content**: MDX with Content Collections API
- **Image Processing**: Sharp 0.34.x (REQUIRED for Astro Image optimization)
- **Code Highlighting**: Shiki (build-time)
- **Comments**: Giscus (GitHub Discussions)
- **Analytics**: Vercel Analytics (integrated in BaseLayout.astro)
- **TypeScript**: 5.x with strict mode

## Commands

```bash
# Development
pnpm dev                 # Start dev server at localhost:4321
pnpm build              # Production build to ./dist/
pnpm preview            # Preview production build

# Code Quality
pnpm lint               # Run ESLint with auto-fix
pnpm format             # Format with Prettier
pnpm check              # TypeScript type checking (astro check)
```

**Important**: To save tokens, do NOT automatically run build/check/lint/format commands. Instead, ask the user to run these commands manually and report back when complete.

## Architecture

### Astro Islands Pattern

- **Astro Components** (`.astro`): Static components with 0 bytes JS by default
- **React Components** (`.tsx`): Only for interactive features that need state/events
- Use `client:load` or `client:idle` directives sparingly

### Component Classification Rules

- **React (.tsx)**: Components with useState, useEffect, onClick handlers
- **Astro (.astro)**: Everything else (layouts, static UI, wrappers)
- Current React components: None (search feature postponed due to React 19 compatibility)

### Content Management

- **Blog Posts**: `src/content/blog/*.mdx` - MDX files with frontmatter
- **Content Schema**: Defined in `src/content/config.ts` using Zod
- **Categories**: Defined in `src/content/categories.json` (Development, Library, Projects, Performance, TypeScript)
- **Category System**: Single category per post (broad classification) + multiple tags (specific topics)
- **Images**: Store in `src/assets/posts/[post-name]/` for Astro Image optimization
- **Access**: Use `getCollection("blog")` from `astro:content`

#### Blog Post Frontmatter

```yaml
title: string
description: string
pubDate: Date (YYYY-MM-DDTHH:mm:ssZ format)
updatedDate?: Date (optional)
heroImage?: ImageMetadata (../../assets/posts/folder/image.jpg)
category: string (must match categories.json)
tags: string[]
draft: boolean
```

#### Creating New Blog Posts

1. Create MDX file in `src/content/blog/[post-name].mdx`
2. Add hero image (if any) to `src/assets/posts/[post-name]/`
3. Ensure `category` matches one from `src/content/categories.json`
4. Use lowercase for tags (consistency)
5. Set `draft: true` for unpublished posts
6. Use ISO 8601 format for dates: `2024-03-13T00:00:00Z`

### Styling Approach

- **NO embedded `<style>` tags or @apply directives**
- **Use inline TailwindCSS utility classes only**
- **Exception**: `src/styles/global.css` for MDX prose styles (`.prose h2`, `.prose p`, etc.)
- **NO dark mode**: All dark mode code has been removed
- **Design System**: Minimalist gray tones (gray-50 to gray-900) with blue accents only for categories (bg-blue-100, text-blue-800)
- **Interactive Components**: Use Intersection Observer API for scroll-based features (see TOC.astro)

### URL Structure

- Posts: `/posts/[slug]`
- Categories: `/categories/[category]` (lowercase)
- Tags: `/tags/[tag]` (lowercase)
- RSS: `/rss.xml`
- Sitemap: Auto-generated by @astrojs/sitemap

**CRITICAL**: Always use `post.slug` for URLs, NOT `post.id`

- `post.id` includes file extension (e.g., "Luxon.mdx")
- `post.slug` is URL-safe without extension (e.g., "luxon")
- Bad: `params: { slug: post.id }` → `/posts/Luxon.mdx/`
- Good: `params: { slug: post.slug }` → `/posts/luxon/`

### Image Optimization

- **CRITICAL**: Sharp must be installed as a dependency (`pnpm add sharp`)
- **Astro Image Component**: Used in Card.astro and [slug].astro
- **Storage**: `src/assets/posts/[post-name]/` (NOT `public/`)
- **Type**: `heroImage: image().optional()` in Content Collections schema returns `ImageMetadata`
- **Auto-optimization**: JPG/PNG → WebP, responsive srcset, lazy loading
- **BlogPost Type**: `heroImage?: ImageMetadata` in `src/types/index.ts`
- **Vercel Deployment**: Without Sharp, builds will fail with MissingSharp error

### Key Files

- `astro.config.mjs`: Site URL (https://ywc.life), integrations, Shiki config (github-dark theme)
- `src/content/config.ts`: Content Collections schema with `image()` helper
- `src/content/categories.json`: Available categories (Development, Library, Projects, Performance, TypeScript)
- `src/types/index.ts`: TypeScript types including BlogPost with ImageMetadata
- `src/layouts/BaseLayout.astro`: Base HTML structure, SEO component
- `src/components/astro/SEO.astro`: Reusable SEO meta tags (OG, Twitter Card)
- `src/components/astro/Card.astro`: Blog post card with hero image, category, tags links
- `src/components/astro/Header.astro`: Navigation with Development/Library categories
- `src/components/astro/Footer.astro`: Footer with RSS and GitHub links
- `src/components/astro/TOC.astro`: Table of contents with Intersection Observer for current section highlighting
- `src/pages/posts/[slug].astro`: Post detail page with hero image display and TOC sidebar
- `src/pages/404.astro`: Custom 404 page with recent posts suggestions
- `.nvmrc`: Node 20 for Vercel deployment

## Development Constraints

- **No SSR**: Static generation only (`astro build`)
- **Build-time processing**: MDX, Shiki, image optimization all at build time
- **No state management libraries**: Use Astro's built-in features
- **No dark mode**: Removed for simplicity
- **Search feature postponed**: React 19 + @astrojs/react compatibility issues

## Deployment

### Vercel (Recommended)

Project is configured for Vercel deployment:

- **Site URL**: https://ywc.life (set in `astro.config.mjs`)
- **Build Command**: `pnpm build`
- **Output Directory**: `dist`
- **Install Command**: `pnpm install`
- **CRITICAL**: Sharp must be in dependencies for image optimization to work

`vercel.json`:

```json
{
  "buildCommand": "pnpm build",
  "devCommand": "pnpm dev",
  "installCommand": "pnpm install",
  "framework": "astro",
  "outputDirectory": "dist"
}
```

### Giscus Configuration

Giscus comments are already configured in `src/components/astro/Comments.astro`:

```typescript
const repo = "ywc0008/blog";
const repoId = "R_kgDOQ1_i3A";
const category = "General";
const categoryId = "DIC_kwDOQ1_i3M4C0zIb";
```

These values are public and safe to commit. Comments are displayed via GitHub Discussions integration.

## Security

### XSS Protection

- Astro and React provide automatic XSS protection by default
- MDX content is safely rendered through Astro's Content Collections API
- All user-facing content is validated through Zod schemas in `src/content/config.ts`
- No unsafe HTML rendering patterns are used in this codebase

### External Links

- External links must include `rel="noopener noreferrer"` to prevent tabnabbing attacks
- Example pattern in `Footer.astro`:
  ```typescript
  target={link.href.startsWith("http") ? "_blank" : undefined}
  rel={link.href.startsWith("http") ? "noopener noreferrer" : undefined}
  ```

### Third-Party Scripts

- Giscus script loaded from `https://giscus.app/client.js` with `crossOrigin="anonymous"`
- Vercel Analytics integrated via official `@vercel/analytics` package
- No Subresource Integrity (SRI) hashes used (not provided by Giscus)

### Content Security

- All blog content stored in Git repository (version controlled)
- Draft posts filtered at build time via `draft: boolean` frontmatter field
- No runtime content injection or dynamic user input processing
- Static site generation eliminates SQL/command injection vectors

## Known Issues & Important Notes

- **Sharp Dependency**: MUST be installed for Astro Image. Vercel builds fail without it (MissingSharp error)
- React 19 with @astrojs/react may have compatibility issues with hooks
- Search/filter features are postponed until React compatibility is resolved
- **Git Commits**:
  - Write commit messages in Korean (project convention)
  - DO NOT add "Co-Authored-By: Claude Sonnet 4.5" to commit messages
  - Follow conventional commits format: `feat:`, `fix:`, `docs:`, `design:`, etc.

<!-- MANUAL ADDITIONS START -->
<!-- MANUAL ADDITIONS END -->
