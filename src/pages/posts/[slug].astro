---
import { Image } from "astro:assets";
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/astro/Header.astro";
import Footer from "../../components/astro/Footer.astro";
import TOC from "../../components/astro/TOC.astro";
import Comments from "../../components/astro/Comments.astro";
import Mermaid from "../../components/astro/Mermaid.astro";
import { calculateReadingTime } from "../../utils/post";
import categories from "../../content/categories.json";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .filter((post) => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

// Calculate reading time from post body
const readingTime = calculateReadingTime(post.body);

const formattedDate = new Intl.DateTimeFormat("ko-KR", {
  year: "numeric",
  month: "long",
  day: "numeric",
}).format(new Date(post.data.pubDate));

const formattedUpdatedDate = post.data.updatedDate
  ? new Intl.DateTimeFormat("ko-KR", {
      year: "numeric",
      month: "long",
      day: "numeric",
    }).format(new Date(post.data.updatedDate))
  : null;

// Word count for structured data
const wordCount = post.body ? post.body.split(/\s+/).length : 0;

// Find category info for breadcrumb
const categoryInfo = categories.find((c) => c.name === post.data.category);

// Breadcrumb data for JSON-LD
const breadcrumb = [
  { name: "홈", url: "https://ywc.life/" },
  ...(categoryInfo
    ? [{ name: categoryInfo.name, url: `https://ywc.life/categories/${categoryInfo.slug}` }]
    : []),
  { name: post.data.title, url: `https://ywc.life/posts/${post.slug}` },
];
---

<BaseLayout
  title={`${post.data.title} - ywc.life`}
  description={post.data.description}
  image={post.data.heroImage?.src}
  type="article"
  breadcrumb={breadcrumb}
  article={{
    publishedTime: post.data.pubDate.toISOString(),
    modifiedTime: post.data.updatedDate?.toISOString(),
    author: "ywc",
    tags: post.data.tags,
    section: post.data.category,
    wordCount: wordCount,
  }}
>
  <div class="min-h-screen flex flex-col">
    <Header />

    <main class="flex-1">
      <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="flex gap-8">
          <!-- Main content -->
          <div class="flex-1 min-w-0">
            <header class="mb-8">
              <div class="flex flex-wrap items-center gap-3 text-sm mb-4">
                <a
                  href={`/categories/${categoryInfo?.slug || post.data.category.toLowerCase()}`}
                  class="px-2 py-1 bg-blue-100 text-blue-800 rounded font-medium hover:bg-blue-200 transition-colors"
                  >{post.data.category}</a
                >
                <time datetime={post.data.pubDate.toISOString()} class="text-gray-600"
                  >{formattedDate}</time
                >
                <span class="text-gray-600">{readingTime}분 읽기</span>
              </div>

              <h1 class="text-4xl sm:text-5xl font-bold mb-4 text-gray-900">{post.data.title}</h1>
              <!-- <p class="text-xl text-gray-600 mb-4">{post.data.description}</p> -->

              {
                formattedUpdatedDate && (
                  <p class="text-sm text-gray-500 italic mb-4">
                    마지막 업데이트:{" "}
                    <time datetime={post.data.updatedDate!.toISOString()}>
                      {formattedUpdatedDate}
                    </time>
                  </p>
                )
              }

              <div class="flex flex-wrap gap-2">
                {
                  post.data.tags.map((tag) => (
                    <a
                      href={`/tags/${tag.toLowerCase()}`}
                      class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors"
                    >
                      {tag}
                    </a>
                  ))
                }
              </div>
            </header>

            <address class="not-italic text-sm text-gray-500 mb-6 flex items-center gap-1">
              <span>작성자:</span>
              <a rel="author" href="/" class="text-gray-700 hover:text-gray-900">ywc</a>
            </address>

            {
              post.data.heroImage && (
                <Image
                  src={post.data.heroImage}
                  alt={post.data.title}
                  width={1200}
                  height={1200}
                  class="w-full rounded-lg mb-8"
                  loading="eager"
                  format="webp"
                />
              )
            }

            <div class="prose prose-lg max-w-none text-gray-800 leading-relaxed">
              <Content />
            </div>

            <Mermaid />

            <Comments />
          </div>

          <!-- Sidebar with TOC -->
          {
            headings.length > 0 && (
              <aside class="hidden lg:block w-64 shrink-0">
                <TOC headings={headings} />
              </aside>
            )
          }
        </div>
      </article>
    </main>

    <Footer />
  </div>
</BaseLayout>
