---
// Mermaid.astro - Lazy loads Mermaid library only when mermaid code blocks exist
---

<script is:inline>
  (function () {
    var blocks = document.querySelectorAll('pre[data-language="mermaid"]');
    if (blocks.length === 0) return;

    var script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js";
    script.onload = function () {
      mermaid.initialize({ startOnLoad: false, theme: "default" });

      blocks.forEach(function (block, index) {
        var code = block.textContent || "";
        var container = document.createElement("div");
        container.className = "mermaid-diagram";

        mermaid
          .render("mermaid-svg-" + index, code.trim())
          .then(function (result) {
            container.innerHTML = result.svg;
            block.replaceWith(container);
          })
          .catch(function (err) {
            var errMsg = document.createElement("p");
            errMsg.style.cssText = "color: red; font-size: 0.875rem;";
            errMsg.textContent = "Mermaid 렌더링 오류: " + err.message;
            container.appendChild(errMsg);
            block.replaceWith(container);
          });
      });
    };
    document.head.appendChild(script);
  })();
</script>
