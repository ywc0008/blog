---
export interface Heading {
  depth: number;
  slug: string;
  text: string;
}

export interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// Filter to only show h2 and h3
const filteredHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

{
  filteredHeadings.length > 0 && (
    <nav class="sticky top-20 p-4 rounded-lg bg-gray-50 border border-gray-200">
      <h2 class="text-lg font-bold mb-3 text-gray-900">목차</h2>
      <ul class="list-none m-0 p-0 space-y-1">
        {filteredHeadings.map((heading) => (
          <li class={`text-sm ${heading.depth === 3 ? "ml-4" : "ml-0"}`}>
            <a
              href={`#${heading.slug}`}
              data-heading-slug={heading.slug}
              class="toc-link block py-1.5 px-2 -mx-2 text-gray-600 no-underline hover:text-gray-900 transition-all duration-200 border-l-2 border-transparent"
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<script>
  // Smooth scroll behavior
  document.querySelectorAll(".toc-link").forEach((link) => {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      const targetId = link.getAttribute("href")?.slice(1);
      if (targetId) {
        const target = document.getElementById(targetId);
        target?.scrollIntoView({ behavior: "smooth" });
      }
    });
  });

  // Highlight current section
  const observerOptions = {
    rootMargin: "-20% 0px -35% 0px",
    threshold: 0,
  };

  const headings = document.querySelectorAll("article h2[id], article h3[id]");
  const tocLinks = document.querySelectorAll(".toc-link");

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const id = entry.target.getAttribute("id");
      const tocLink = document.querySelector(`.toc-link[data-heading-slug="${id}"]`);

      if (entry.isIntersecting) {
        // Remove active state from all links
        tocLinks.forEach((link) => {
          link.classList.remove("border-gray-900", "text-gray-900", "font-semibold", "bg-gray-100");
          link.classList.add("border-transparent", "text-gray-600");
        });

        // Add active state to current link
        if (tocLink) {
          tocLink.classList.remove("border-transparent", "text-gray-600");
          tocLink.classList.add("border-gray-900", "text-gray-900", "font-semibold", "bg-gray-100");
        }
      }
    });
  }, observerOptions);

  headings.forEach((heading) => {
    observer.observe(heading);
  });
</script>
